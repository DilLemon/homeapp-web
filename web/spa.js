const $=(s,r=document)=>r.querySelector(s);const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));function token(){return localStorage.getItem('token')||''}function setToken(t){if(t)localStorage.setItem('token',t);else localStorage.removeItem('token');syncAuthUI()}function authHeaders(){return token()?{'Authorization':'Bearer '+token()}:{} }function json(res){if(!res.ok)throw new Error('HTTP '+res.status);return res.json()}function fmt(n){return Number(n).toLocaleString('ru-RU',{minimumFractionDigits:2,maximumFractionDigits:2})}function syncAuthUI(){const has=!!token();$('#loginLink').style.display=has?'none':'inline';$('#logoutBtn').style.display=has?'inline':'none'}$('#logoutBtn').addEventListener('click',()=>{setToken('');location.hash='#/login'});const routes={'/login':renderLogin,'/dashboard':renderDashboard,'/transactions':renderTransactions,'/habits':renderHabits,'/categories':renderCategories,'/export':renderExport};function router(){const path=location.hash.replace('#','')||'/dashboard';(routes[path]||renderDashboard)()}window.addEventListener('hashchange',router);function mount(tplId){const tpl=document.getElementById(tplId);const node=tpl.content.cloneNode(true);const app=$('#app');app.innerHTML='';app.appendChild(node)}async function renderLogin(){mount('tpl-login');syncAuthUI();const f=$('#loginForm');f.happened_at&&(f.happened_at.valueAsDate=new Date());f.addEventListener('submit',async e=>{e.preventDefault();$('#loginErr').textContent='';try{const res=await fetch(`${API_BASE}/api/auth/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:f.username.value.trim(),password:f.password.value})}).then(json);setToken(res.access_token);location.hash='#/dashboard'}catch(err){$('#loginErr').textContent='Неверный логин или пароль'}})}async function renderDashboard(){if(!token()){location.hash='#/login';return}mount('tpl-dashboard');syncAuthUI();try{const spending=await fetch(`${API_BASE}/api/reports/spending?scope=mine`,{headers:authHeaders()}).then(json);const ctx1=$('#pie');new Chart(ctx1,{type:'pie',data:{labels:spending.map(x=>x.category),datasets:[{data:spending.map(x=>x.total)}]},options:{plugins:{legend:{position:'bottom'}}}});const year=new Date().getFullYear();const trends=await fetch(`${API_BASE}/api/reports/trends?year=${year}&scope=mine`,{headers:authHeaders()}).then(json);const ctx2=$('#line');new Chart(ctx2,{type:'line',data:{labels:trends.map(x=>x.period),datasets:[{label:'Доход',data:trends.map(x=>x.income)},{label:'Расход',data:trends.map(x=>x.expense)}]}})}catch(e){$('#app').innerHTML+='<p class="err">Не удалось загрузить отчеты</p>'}}async function renderTransactions(){if(!token()){location.hash='#/login';return}mount('tpl-transactions');syncAuthUI();const f=$('#txForm');f.happened_at.valueAsDate=new Date();const [cats,accs]=await Promise.all([fetch(`${API_BASE}/api/categories`,{headers:authHeaders()}).then(json),fetch(`${API_BASE}/api/accounts`,{headers:authHeaders()}).then(json)]);cats.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.name;f.category_id.appendChild(o)});accs.forEach(a=>{const o=document.createElement('option');o.value=a.id;o.textContent=a.name;f.account_id.appendChild(o)});async function loadTx(){const tx=await fetch(`${API_BASE}/api/transactions`,{headers:authHeaders()}).then(json);const tb=$('#txTable tbody');tb.innerHTML='';tx.forEach(t=>{const tr=document.createElement('tr');const cat=cats.find(c=>c.id===t.category_id)?.name||t.category_id;tr.innerHTML=`<td>${t.happened_at}</td><td>${cat}</td><td>${fmt(t.amount)}</td><td>${t.note||''}</td>`;tb.appendChild(tr)})}await loadTx();f.addEventListener('submit',async e=>{e.preventDefault();const payload={amount:parseFloat(f.amount.value),category_id:Number(f.category_id.value),account_id:Number(f.account_id.value||accs[0]?.id),happened_at:f.happened_at.value,note:f.note.value,currency:'RUB'};await fetch(`${API_BASE}/api/transactions`,{method:'POST',headers:{'Content-Type':'application/json',...authHeaders()},body:JSON.stringify(payload)}).then(json);f.amount.value='';f.note.value='';await loadTx()})}async function renderHabits(){if(!token()){location.hash='#/login';return}mount('tpl-habits');syncAuthUI();async function load(){const hs=await fetch(`${API_BASE}/api/habits`,{headers:authHeaders()}).then(json);const ul=$('#habitList');ul.innerHTML='';hs.forEach(h=>{const li=document.createElement('li');li.className='row gap';li.style.justifyContent='space-between';const btn=document.createElement('button');btn.className='btn';btn.textContent='Чек-ин';btn.onclick=async()=>{const today=new Date().toISOString().slice(0,10);await fetch(`${API_BASE}/api/habits/${h.id}/checkins`,{method:'POST',headers:{'Content-Type':'application/json',...authHeaders()},body:JSON.stringify({date:today,value:1})}).then(json);await load()};li.innerHTML=`<span>${h.title}</span>`;li.appendChild(btn);ul.appendChild(li)})}await load();$('#habitForm').addEventListener('submit',async e=>{e.preventDefault();const title=e.target.title.value.trim();if(!title)return;await fetch(`${API_BASE}/api/habits`,{method:'POST',headers:{'Content-Type':'application/json',...authHeaders()},body:JSON.stringify({title,periodicity:'daily'})}).then(json);e.target.title.value='';await load()})}async function renderCategories(){if(!token()){location.hash='#/login';return}mount('tpl-categories');syncAuthUI();async function load(){const cs=await fetch(`${API_BASE}/api/categories`,{headers:authHeaders()}).then(json);const ul=$('#catList');ul.innerHTML='';cs.forEach(c=>{const li=document.createElement('li');li.className='row gap';li.style.justifyContent='space-between';li.innerHTML=`<span>${c.name}</span><span class="muted">${c.type}</span>`;ul.appendChild(li)})}await load();$('#catForm').addEventListener('submit',async e=>{e.preventDefault();const name=e.target.name.value.trim();const type=e.target.type.value;if(!name)return;await fetch(`${API_BASE}/api/categories`,{method:'POST',headers:{'Content-Type':'application/json',...authHeaders()},body:JSON.stringify({name,type})}).then(json);e.target.name.value='';await load()})}async function renderExport(){if(!token()){location.hash='#/login';return}mount('tpl-export');syncAuthUI();$('#csvLink').href=`${API_BASE}/api/export/csv`;$('#xlsxLink').href=`${API_BASE}/api/export/xlsx`}syncAuthUI();router();